import React, { useState, useEffect, useMemo } from 'react';
import { BookOpen, User, Briefcase, Heart, Globe, RefreshCcw, CheckCircle, AlertCircle, HelpCircle, ChevronRight, Award, Zap, Smile, Save, Download, Mail, RotateCcw, X, Trophy, Users, Baby, Handshake, Siren, Sparkles, MapPin, Clock, LogOut, Info, Lightbulb, Share2, Calendar, Star, Coins, PenTool, Plane, Crown, Send, Lock } from 'lucide-react';

// -----------------------------------------------------------------------------
// 1. 圖示與資料設定 (Icons & Data)
// -----------------------------------------------------------------------------

// 線條風格魔法帽 (無填充，回歸原始設計)
const MagicHat = ({ className, color = "currentColor" }) => (
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
    <path d="M2 21H22" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M19 21C19 21 20.5 16 18 12C15.5 8 16 2 12 2C8 2 8.5 8 6 12C3.5 16 5 21 5 21" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M12 2C12 2 13 5 15 6" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M5 21C5 21 6.5 17 12 18C17.5 19 19 21 19 21" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

const HATS_INFO = {
  White: {
    color: "White",
    name: "白帽",
    meaning: "客觀、數據、事實",
    desc: "中立而客觀。不帶情感，只關注訊息、數據與既有事實。",
    detailedDesc: "您習慣像科學家一樣思考，這讓您在混亂中總能保持冷靜。",
    deepAnalysis: "親愛的白帽思考者：\n\n您的思維核心是「清澈」。在這個充滿雜訊的時代，您擁有極其珍貴的能力——將「事實」與「詮釋」分開。\n\n您不會被情緒綁架，也不會盲目跟風。當所有人都在爭論「我覺得」的時候，您會冷靜地問：「數據在哪裡？」。這種特質讓您成為團隊中定海神針般的存在。\n\n您的決策往往經得起時間的考驗，因為它們建立在堅實的基礎之上。請繼續保持這份客觀，但也請記得，有時候數據無法衡量人心的溫度，適時戴上紅帽，您的領導力將無懈可擊。",
    keywords: ["數據分析", "事實陳述", "中立客觀", "資訊缺口", "歷史紀錄"],
    celebrities: [
      { name: "夏洛克·福爾摩斯", desc: "名偵探", detail: "「數據！數據！沒有數據我無法砌磚。」" },
      { name: "瑪麗·居禮", desc: "科學家", detail: "以嚴謹的實驗數據為基礎，揭示了放射性元素的真相。" },
      { name: "史巴克 (Spock)", desc: "星際爭霸戰", detail: "瓦肯人的邏輯代表，永遠提供最合乎邏輯與數據的分析。" }
    ],
    style: "bg-white text-slate-800 border-slate-300 shadow-slate-200",
    hatColor: "bg-white border-2 border-slate-200 text-slate-700",
    strokeColor: "#475569",
    oracles: [
      "今天請戴上白帽。在開口表達意見前，先問自己：「我有數據支持這個看法嗎？」",
      "暫時放下你的猜測。今天只記錄你親眼看到、親耳聽到的事實。",
      "如果感覺困惑，就去查資料。今天的力量來自於「已知」的資訊。",
      "試著用數字說話。不要說「很多人」，試著找出是「百分之幾」。"
    ]
  },
  Red: {
    color: "Red",
    name: "紅帽",
    meaning: "情感、直覺、預感",
    desc: "情緒與感覺。不需要理由，純粹表達直覺、喜好與憤怒。",
    detailedDesc: "您擁有強大的直覺與共情能力，是團隊的溫度計。",
    deepAnalysis: "親愛的紅帽思考者：\n\n您的思維核心是「熱情」。您不需要邏輯證明，您的直覺往往比數據更快抵達真相。\n\n您對人與環境的感知力極強，這讓您在人際溝通、談判與藝術創作上擁有得天獨厚的天賦。您懂得「人心」才是所有商業與合作的根本。當別人還在分析利弊時，您已經感覺到了機會（或危險）的味道。\n\n請珍視您的情緒，那不是干擾，而是最高效的導航系統。只要學會偶爾用白帽檢查一下路徑，您的直覺將帶領您前往別人無法想像的精彩之地。",
    keywords: ["直覺預感", "情緒表達", "個人喜好", "恐懼焦慮", "價值觀"],
    celebrities: [
      { name: "歐普拉", desc: "脫口秀女王", detail: "依靠強大的共情能力與直覺，建立起與觀眾深厚的情感連結。" },
      { name: "史蒂夫·賈伯斯", desc: "蘋果創辦人", detail: "在產品設計上極度依賴直覺與美感，而非市場調查數據。" },
      { name: "達賴喇嘛", desc: "精神領袖", detail: "以慈悲與同理心為視角，強調人類情感與心靈的連結。" }
    ],
    style: "bg-red-50 text-red-900 border-red-200 shadow-red-100",
    hatColor: "bg-red-600 text-white",
    strokeColor: "#dc2626",
    oracles: [
      "今天請戴上紅帽。如果這件事讓你感覺不對勁，那就停下來。",
      "不要壓抑情緒。今天試著對信任的人誠實說出：「我現在感覺...」",
      "做一個情緒掃描。你的身體現在是緊繃的還是放鬆的？",
      "如果讓你感到興奮，就放手去做！熱情是今天最好的燃料。"
    ]
  },
  Black: {
    color: "Black",
    name: "黑帽",
    meaning: "謹慎、風險、批判",
    desc: "邏輯上的否定。關注風險、潛在問題、為什麼這樣做行不通。",
    detailedDesc: "您是天生的守護者，擅長在危機發生前就將其消弭。",
    deepAnalysis: "親愛的黑帽思考者：\n\n您的思維核心是「生存」。這不是悲觀，這是極致的「保護力」。您擁有鷹一般的銳利眼光，總能看見別人忽略的隱患。\n\n在這個盲目正向的世界裡，您的存在至關重要。您幫助團隊省下了巨額的試錯成本，避開了法律風險，確保了計畫的可執行性。您不是在潑冷水，您是在築防火牆。\n\n您的謹慎是成功的基石。只要記得，在指出三個風險的同時，試著搭配一頂黃帽找出一個解決方案，您將成為最令人安心的智囊。",
    keywords: ["風險評估", "邏輯批判", "潛在障礙", "合規檢查", "最壞打算"],
    celebrities: [
      { name: "華倫·巴菲特", desc: "股神", detail: "投資哲學極度保守，第一條規則是「不要虧錢」，專注於避開風險。" },
      { name: "查理·蒙格", desc: "投資大師", detail: "總是「反過來想」，專注於研究企業如何失敗，以此來避免失敗。" },
      { name: "薩利機長", desc: "哈德遜奇蹟", detail: "在引擎失效的極端危機中，迅速評估所有不可行的方案，找出唯一的生路。" }
    ],
    style: "bg-slate-900 text-slate-50 border-slate-700 shadow-slate-400",
    hatColor: "bg-black text-white",
    strokeColor: "#0f172a",
    oracles: [
      "今天請戴上黑帽。在做決定前，先停下來想一想：「最壞的情況是什麼？」",
      "謹慎是美德。今天不要急著答應任何請求，先說「讓我考慮一下」。",
      "檢查細節。魔鬼藏在細節裡，今天你的銳利眼光能抓出隱藏的錯誤。",
      "反過來想。如果這件事失敗了，會是因為什麼原因？先把它補起來。"
    ]
  },
  Yellow: {
    color: "Yellow",
    name: "黃帽",
    meaning: "樂觀、利益、建設性",
    desc: "積極與正向。尋找優點、價值與利益，探索可行性。",
    detailedDesc: "您總是能看見烏雲後的金邊，是團隊前進的動力。",
    deepAnalysis: "親愛的黃帽思考者：\n\n您的思維核心是「希望」。您擁有一種特殊能力，能在荒漠中看見綠洲，在絕境中看見轉機。\n\n這不只是樂觀，這是一種「價值發現」的能力。當別人抱怨問題時，您在思考如何將問題轉化為商機。您是創業家精神的化身，您的能量能感染身邊的人，讓大家願意跟隨您去挑戰不可能。\n\n請繼續保持這份光芒。當您遇到阻礙時，搭配一點黑帽的風險評估，您的夢想將會長出翅膀，飛得既高又遠。",
    keywords: ["尋找利益", "探索機會", "正向邏輯", "願景描繪", "可行性"],
    celebrities: [
      { name: "理查·布蘭森", desc: "維珍集團", detail: "永遠對新冒險充滿熱情，即使面臨巨大挑戰，也能看到其中的樂趣。" },
      { name: "魔術強森", desc: "傳奇球星/企業家", detail: "在退役後成功轉型，總是用招牌笑容與樂觀態度面對商業挑戰。" },
      { name: "華特·迪士尼", desc: "夢想家", detail: "在沒人看好動畫電影時，看見了它帶給人們歡樂的巨大價值與潛力。" }
    ],
    style: "bg-yellow-50 text-yellow-900 border-yellow-200 shadow-yellow-100",
    hatColor: "bg-yellow-400 text-yellow-900",
    strokeColor: "#ca8a04",
    oracles: [
      "今天請戴上黃帽。遇到任何倒霉事，強迫自己找出這件事帶來的一個好處。",
      "專注於「可行性」。不要說「這不可能」，試著說「如果要做，我們可以怎麼做」。",
      "讚美別人。今天試著發現身邊每個人的一個優點，並告訴他們。",
      "看到願景。想像一下事情成功後的樣子，讓那個畫面激勵你。"
    ]
  },
  Green: {
    color: "Green",
    name: "綠帽",
    meaning: "創意、新想法、替代方案",
    desc: "創造力與橫向思考。提出新點子、新概念與更多的可能性。",
    detailedDesc: "您的思維不受框架限制，總是能帶來意想不到的驚喜。",
    deepAnalysis: "親愛的綠帽思考者：\n\n您的思維核心是「生長」。您不滿足於標準答案，您的大腦就像一座繁茂的森林，隨時都在孕育新的點子。\n\n您是改變的催化劑。當團隊陷入僵局，大家會看向您，期待您提出那個「瘋狂但有效」的替代方案。您懂得橫向思考，能將毫不相關的事物連結起來，創造出全新的價值。\n\n請保護好您的好奇心，那是您最鋒利的武器。只要再加上藍帽的執行規劃，您的創意將不只是空想，而能改變世界。",
    keywords: ["創意思考", "替代方案", "打破框架", "新穎概念", "橫向連結"],
    celebrities: [
      { name: "達文西", desc: "文藝復興全才", detail: "筆記本充滿了飛行器等超越時代的構想，不受當時知識限制。" },
      { name: "愛因斯坦", desc: "物理學家", detail: "透過「思想實驗」（如追著光跑）來突破傳統物理學的框架。" },
      { name: "伊隆·馬斯克", desc: "SpaceX創辦人", detail: "提出殖民火星等激進想法，致力於將科幻小說的情節變為現實。" }
    ],
    style: "bg-green-50 text-green-900 border-green-200 shadow-green-100",
    hatColor: "bg-green-600 text-white",
    strokeColor: "#166534",
    oracles: [
      "今天請戴上綠帽。走一條沒走過的路回家，或是點一道從沒吃過的菜。",
      "打破慣性！試著用非慣用手刷牙，或是把辦公桌重新擺設一下。",
      "沒有標準答案。面對問題時，逼自己想出至少三個解決方案。",
      "把兩個不相干的東西連在一起。這會是你今天創意的來源。"
    ]
  },
  Blue: {
    color: "Blue",
    name: "藍帽",
    meaning: "控制、流程、統籌",
    desc: "思維的控制者。負責組織討論流程、總結與決策。",
    detailedDesc: "您擁有宏觀的視野，擅長組織、規劃與引導。",
    deepAnalysis: "親愛的藍帽思考者：\n\n您的思維核心是「秩序」。您就像一位高明的指揮家，您不一定親自演奏樂器，但您知道何時該讓誰發聲，才能奏出最和諧的樂章。\n\n您擁有卓越的後設認知（思考關於思考）能力。在混亂的討論中，您是那個能跳出來喊暫停，重新釐清目標、設定議程的人。您的領導力來自於清晰的邏輯與對大局的掌控。\n\n您是團隊的大腦。請繼續引導大家前進，您的存在讓所有人的努力都有了方向與意義。",
    keywords: ["流程控制", "歸納總結", "議程設定", "大局觀", "紀律維持"],
    celebrities: [
      { name: "溫斯頓·邱吉爾", desc: "英國首相", detail: "以卓越的大局觀與組織能力，統籌盟軍資源，指揮若定。" },
      { name: "彼得·杜拉克", desc: "管理學之父", detail: "擅長抽絲剝繭，將複雜的商業現象歸納為清晰的管理原則與流程。" },
      { name: "李光耀", desc: "新加坡國父", detail: "以極強的紀律與長遠規劃，將一個資源匱乏的小島國建設成國際金融中心。" }
    ],
    style: "bg-blue-50 text-blue-900 border-blue-200 shadow-blue-100",
    hatColor: "bg-blue-600 text-white",
    strokeColor: "#1e40af",
    oracles: [
      "今天請戴上藍帽。不要急著動手，先規劃流程，列出 To-Do List。",
      "後退一步看。不要陷入細節，問自己：「我們現在的目標是什麼？」",
      "做個總結。在結束對話前，試著歸納對方的重點，確保雙方同頻。",
      "控制節奏。如果你覺得混亂，就喊暫停，重新整理思緒再出發。"
    ]
  }
};

const QUESTION_POOL = [
  // 創業/工作類
  { id: 'w1', category: "Work", q: "當朋友向你提出一個瘋狂的創業點子時，你的第一個反應通常是？", options: [
    { hat: "Green", text: "太酷了！我們還可以加上這個功能，甚至可以那樣做..." },
    { hat: "Black", text: "聽起來風險很高，你有考慮過失敗的成本嗎？" },
    { hat: "Yellow", text: "如果成功的話，這會帶來巨大的財富和影響力！" },
    { hat: "White", text: "目前的市場數據顯示這類產品的成功率是多少？" }
  ]},
  { id: 'w2', category: "Work", q: "老闆突然在會議上提出一個重大轉型計畫，你會？", options: [
    { hat: "Blue", text: "我們需要先制定一個評估流程，確認每個部門的影響。" },
    { hat: "Red", text: "我直覺覺得這個方向不對，這會讓大家很混亂。" },
    { hat: "Yellow", text: "這是一個很好的機會，能讓我們搶佔先機！" },
    { hat: "Black", text: "這樣做會導致現有的客戶流失，營收可能會下滑。" }
  ]},
  { id: 'w3', category: "Work", q: "面對一個複雜的新工作任務，你如何開始？", options: [
    { hat: "White", text: "先蒐集所有相關的資料、文件和歷史紀錄。" },
    { hat: "Blue", text: "先規劃步驟，列出時間表，分配資源。" },
    { hat: "Green", text: "想想要怎麼用創新的方式來完成它，讓大家耳目一新。" },
    { hat: "Black", text: "先檢查哪裡最容易出錯，把地雷先排掉。" }
  ]},
  { id: 'w4', category: "Work", q: "公司業績連續三個月下滑，你會專注於？", options: [
    { hat: "White", text: "調出近三年的財報與市場分析報告，找出具體變因。" },
    { hat: "Red", text: "我感覺是團隊士氣低落的問題，大家都很焦慮。" },
    { hat: "Green", text: "我們應該開發一個全新的產品線來扭轉局勢。" },
    { hat: "Black", text: "如果不馬上止血，公司可能撐不過半年。" }
  ]},
  { id: 'w5', category: "Work", q: "你需要決定是否錄取一位很有才華但個性古怪的面試者。", options: [
    { hat: "Red", text: "我不喜歡他給我的感覺，我覺得他會破壞團隊氣氛。" },
    { hat: "Yellow", text: "他的才華無可取代，能為公司帶來突破性的技術成長。" },
    { hat: "Black", text: "他的穩定性令人擔憂，過去的跳槽紀錄顯示他可能待不久。" },
    { hat: "White", text: "查看他的過往作品集與前公司的推薦信內容。" }
  ]},
  { id: 'w6', category: "Work", q: "專案死線(Deadline)逼近，但進度嚴重落後。", options: [
    { hat: "Blue", text: "立即召開緊急會議，重新分配工作，設定每日檢查點。" },
    { hat: "Green", text: "我們是否可以簡化流程，用AI工具來加速開發？" },
    { hat: "Black", text: "如果現在不加班趕工，我們將面臨違約金的賠償。" },
    { hat: "Red", text: "我感到非常焦慮，這壓力讓我喘不過氣。" }
  ]},
  { id: 's1', category: "Social", q: "在會議中發生爭執，大家都僵持不下，你會怎麼做？", options: [
    { hat: "Red", text: "我感到現在氣氛很糟，大家都很挫折，我們先休息一下。" },
    { hat: "Blue", text: "我們先暫停，重新確認一下現在討論的議程和目標是什麼。" },
    { hat: "White", text: "我們先把雙方的觀點條列下來，看看事實依據是什麼。" },
    { hat: "Green", text: "也許我們可以試試看完全不同的第三種解決方案？" }
  ]},
  { id: 's2', category: "Social", q: "朋友遲到了半小時還沒出現，你會？", options: [
    { hat: "Black", text: "路上是不是出車禍了？還是發生什麼意外？" },
    { hat: "Red", text: "我現在覺得很不被尊重，很煩躁。" },
    { hat: "White", text: "看一看手錶，確認已經過了30分鐘，並撥打電話確認位置。" },
    { hat: "Yellow", text: "沒關係，剛好我可以利用這段時間看幾頁書。" }
  ]},
  { id: 's3', category: "Social", q: "面對別人的批評，你通常如何處理？", options: [
    { hat: "Blue", text: "我需要整理一下他說的重點，區分哪些是建議，哪些是情緒。" },
    { hat: "Red", text: "當下感覺很受傷，心裡很不舒服。" },
    { hat: "Green", text: "這或許是一個改變形象的好契機，我可以嘗試全新的風格。" },
    { hat: "Black", text: "他說的有道理，如果不改進，未來可能會造成更大的失敗。" }
  ]},
  { id: 's4', category: "Social", q: "你需要說服一群人支持你的想法，你會強調？", options: [
    { hat: "Yellow", text: "這件事完成後，對大家有什麼好處與願景。" },
    { hat: "White", text: "支持這個想法的客觀證據與成功案例。" },
    { hat: "Red", text: "分享我的熱情與故事，感動他們。" },
    { hat: "Black", text: "如果不這樣做，我們會面臨什麼危險。" }
  ]},
  { id: 'l1', category: "Life", q: "計畫週末出遊，卻發現氣象預報說會下大雨，你會想？", options: [
    { hat: "Black", text: "真倒霉，行程可能會泡湯，路上交通也會很危險。" },
    { hat: "Yellow", text: "沒關係，這樣反而遊客少，我們可以享受室內的行程！" },
    { hat: "Red", text: "我覺得好失望，原本很期待去戶外的。" },
    { hat: "Blue", text: "那我們現在來重新規劃行程表，啟動雨天備案。" }
  ]},
  { id: 'l2', category: "Life", q: "你買了一件昂貴的衣服，回家後發現有點瑕疵，你會？", options: [
    { hat: "Red", text: "我現在真的很生氣，直接拿去退！" },
    { hat: "Yellow", text: "雖然有瑕疵，但這件版型真的很難得，修補一下還是很棒。" },
    { hat: "White", text: "查一下店家的退換貨條款，確認期限和條件。" },
    { hat: "Black", text: "如果不退，之後破洞變大怎麼辦？這是浪費錢。" }
  ]},
  { id: 't4', category: "Tech", q: "對於「元宇宙」的概念，你的第一直覺是？", options: [
    { hat: "Green", text: "想像一下，我們可以完全擺脫物理限制，創造任何想要的世界！" },
    { hat: "White", text: "目前VR設備的普及率和運算能力還不足以支撐完全的元宇宙。" },
    { hat: "Red", text: "我覺得有點可怕，人類會不會因此忘記現實生活？" },
    { hat: "Yellow", text: "這將創造巨大的新經濟體系，帶來無數的工作機會。" }
  ]},
  { id: 'f1', category: "Wealth", q: "朋友報給你一支「保證獲利」的股票名牌，你會？", options: [
    { hat: "Black", text: "天下沒有白吃的午餐，這聽起來像是詐騙或有內線風險。" },
    { hat: "Red", text: "聽起來好誘人！我很想趕快跟上賺一筆。" },
    { hat: "White", text: "先去查這家公司的財報、本益比和近期新聞。" },
    { hat: "Blue", text: "我需要檢視我的投資組合配置，看是否還有空間容納高風險資產。" }
  ]},
  { id: 'c1', category: "Creativity", q: "如果你要寫一本小說，你會先做什麼？", options: [
    { hat: "Green", text: "先不管大綱，直接寫下腦中浮現最瘋狂的場景！" },
    { hat: "Blue", text: "先規劃章節架構，設定人物關係圖和時間軸。" },
    { hat: "Yellow", text: "想像這本書出版後大賣，被改編成電影的樣子，給自己動力。" },
    { hat: "White", text: "研究目前市場上暢銷小說的類型和字數分布。" }
  ]}
];

const CHALLENGE_DB = {
  Life: {
    label: "生活",
    icon: <User className="w-5 h-5" />,
    scenarios: [
      {
        level: "初階",
        score: 10,
        context: "你想開始減肥，但朋友一直約你去吃吃到飽火鍋。",
        targetHat: "Black",
        options: [
          { id: "A", text: "好啊！偶爾吃一次沒關係，心情好比較重要！(樂觀)", hat: "Yellow" },
          { id: "B", text: "這會破壞我的熱量赤字，之前的努力可能白費。(風險)", hat: "Black" },
          { id: "C", text: "我們或許可以去吃火鍋，但我只吃蔬菜？(創意)", hat: "Green" }
        ]
      },
      {
        level: "中階",
        score: 20,
        context: "你考慮領養一隻寵物，但工作很忙。",
        targetHat: "White",
        options: [
          { id: "A", text: "養寵物平均每天需要花費1.5小時照顧，我的工時是10小時。(數據)", hat: "White" },
          { id: "B", text: "有狗狗在門口迎接我回家的感覺一定很棒！(情感)", hat: "Red" },
          { id: "C", text: "萬一我之後要出差，寵物安置會是一個大問題。(風險)", hat: "Black" }
        ]
      }
    ]
  },
  // ... (Challenge scenarios same as before) ...
  Work: {
    label: "工作",
    icon: <Briefcase className="w-5 h-5" />,
    scenarios: [
      {
        level: "中階",
        score: 20,
        context: "公司決定縮減預算，原本的專案資金被砍了一半。",
        targetHat: "Yellow",
        options: [
          { id: "A", text: "這是災難，我們做不出好東西了，專案一定會失敗。", hat: "Black" },
          { id: "B", text: "這迫使我們必須更精簡，其實能幫助我們去除不必要的功能，反而讓產品更聚焦。", hat: "Yellow" },
          { id: "C", text: "目前的預算是50萬，原本是100萬，我們需要重新計算人力成本。", hat: "White" }
        ]
      },
      {
        level: "高階",
        score: 30,
        context: "團隊成員之間發生激烈的衝突，互不相讓。",
        targetHat: "Blue",
        options: [
          { id: "A", text: "請雙方冷靜，現在我們需要制定一個溝通規則，每人輪流發言三分鐘。", hat: "Blue" },
          { id: "B", text: "我覺得你們這樣吵很傷感情，我很難過。", hat: "Red" },
          { id: "C", text: "我們可以舉辦一個拳擊比賽來決定誰對誰錯！", hat: "Green" }
        ]
      }
    ]
  },
  Love: {
    label: "感情",
    icon: <Heart className="w-5 h-5" />,
    scenarios: [
      {
        level: "初階",
        score: 10,
        context: "伴侶忘記了你們的紀念日。",
        targetHat: "White",
        options: [
          { id: "A", text: "他根本不在乎我！我感覺被拋棄了！", hat: "Red" },
          { id: "B", text: "他最近加班時數是過去的兩倍，平均睡眠只有5小時，可能是生理疲勞導致的。", hat: "White" },
          { id: "C", text: "這是分手的徵兆，我們之間完了。", hat: "Black" }
        ]
      },
      {
        level: "中階",
        score: 20,
        context: "你們對於未來的居住城市有不同意見。",
        targetHat: "Blue",
        options: [
          { id: "A", text: "我們輪流住住看，例如各住一個月？", hat: "Green" },
          { id: "B", text: "我們現在來安排一個討論流程：先各自列出前三名理由，再進行交叉比對。", hat: "Blue" },
          { id: "C", text: "如果搬到那裡，我會很想念我的家人，我會很孤單。", hat: "Red" }
        ]
      }
    ]
  },
  Social: {
    label: "社會",
    icon: <Globe className="w-5 h-5" />,
    scenarios: [
      {
        level: "中階",
        score: 20,
        context: "對於「AI是否會取代人類工作」這個議題。",
        targetHat: "Red",
        options: [
          { id: "A", text: "根據高盛的報告，約有3億個職位會受到影響。", hat: "White" },
          { id: "B", text: "我感到很恐懼，覺得未來充滿不確定性，但也有一種對於科技奇點的興奮感。", hat: "Red" },
          { id: "C", text: "AI可以創造全新的工作型態，像是AI溝通師。", hat: "Green" }
        ]
      }
    ]
  },
  Parenting: {
    label: "親子",
    icon: <Baby className="w-5 h-5" />,
    scenarios: [
      {
        level: "初階",
        score: 10,
        context: "孩子在超市大哭大鬧要買糖果。",
        targetHat: "Black",
        options: [
           { id: "A", text: "好啦好啦，別哭了就買給你。", hat: "Red" },
           { id: "B", text: "如果我現在妥協，會建立錯誤的獎勵機制，未來會更難管教。", hat: "Black" },
           { id: "C", text: "我們可以玩一個遊戲，看誰能安靜最久！", hat: "Green" }
        ]
      }
    ]
  },
  Negotiation: {
    label: "談判",
    icon: <Handshake className="w-5 h-5" />,
    scenarios: [
      {
        level: "中階",
        score: 20,
        context: "你正在面試新工作，對方開出的薪水比你預期低。",
        targetHat: "White",
        options: [
          { id: "A", text: "我對於這個數字感到有點失望，我覺得我不只值這樣。", hat: "Red" },
          { id: "B", text: "根據人力銀行的報告，我這個年資的平均薪資是5萬，而貴司開出的是4萬5。", hat: "White" },
          { id: "C", text: "沒關係，或許未來有獎金或升遷機會，先進去再說。", hat: "Yellow" }
        ]
      }
    ]
  },
  Crisis: {
    label: "危機",
    icon: <Siren className="w-5 h-5" />,
    scenarios: [
      {
        level: "初階",
        score: 10,
        context: "出國旅遊時護照和錢包被偷了。",
        targetHat: "Blue",
        options: [
          { id: "A", text: "天啊！怎麼會這樣！我好想哭！", hat: "Red" },
          { id: "B", text: "第一步先掛失信用卡，第二步去警局報案，第三步聯繫辦事處。", hat: "Blue" },
          { id: "C", text: "沒錢了，也許我可以嘗試在街頭表演賺旅費？", hat: "Green" }
        ]
      }
    ]
  },
  SelfGrowth: {
    label: "成長",
    icon: <Sparkles className="w-5 h-5" />,
    scenarios: [
       {
        level: "中階",
        score: 20,
        context: "你感到目前的工作停滯不前，沒有學習動力。",
        targetHat: "Green",
        options: [
          { id: "A", text: "我可以試著跟老闆提議，讓我用20%的時間去跨部門支援？", hat: "Green" },
          { id: "B", text: "再這樣下去，我會失去競爭力，這很危險。", hat: "Black" },
          { id: "C", text: "我真的很厭倦每天重複一樣的事情。", hat: "Red" }
        ]
      }
    ]
  },
  Wealth: {
    label: "理財",
    icon: <Coins className="w-5 h-5" />,
    scenarios: [
      {
        level: "中階",
        score: 20,
        context: "股市大跌，你的帳面虧損達到了20%。",
        targetHat: "White",
        options: [
          { id: "A", text: "我好慌張，我是不是該全部賣掉止損？", hat: "Red" },
          { id: "B", text: "調閱過去十年的大盤數據，確認這是否為正常的市場修正。", hat: "White" },
          { id: "C", text: "這是加碼的好機會，現在股票變便宜了！", hat: "Yellow" }
        ]
      },
      {
        level: "高階",
        score: 30,
        context: "朋友邀請你合資開一間咖啡廳。",
        targetHat: "Black",
        options: [
          { id: "A", text: "太棒了，我一直夢想有一間自己的咖啡廳！", hat: "Yellow" },
          { id: "B", text: "如果不賺錢，我們的友情會不會破裂？合約有寫清楚退場機制嗎？", hat: "Black" },
          { id: "C", text: "我們可以把咖啡廳結合共用工作空間，創造雙重收入。", hat: "Green" }
        ]
      }
    ]
  },
  Creativity: {
    label: "創作",
    icon: <PenTool className="w-5 h-5" />,
    scenarios: [
      {
        level: "初階",
        score: 10,
        context: "你必須在兩天內交出一份設計稿，但你毫無靈感。",
        targetHat: "Green",
        options: [
          { id: "A", text: "死定了，我完蛋了，我真的沒有天份。", hat: "Black" },
          { id: "B", text: "試試看隨機翻開字典的一個詞，強迫它跟我的主題做連結？", hat: "Green" },
          { id: "C", text: "先去睡一覺，保持心情愉快最重要。", hat: "Yellow" }
        ]
      }
    ]
  },
  Travel: {
    label: "旅遊",
    icon: <Plane className="w-5 h-5" />,
    scenarios: [
      {
        level: "中階",
        score: 20,
        context: "你在異國迷路了，手機也沒電了。",
        targetHat: "Yellow",
        options: [
          { id: "A", text: "這真是太危險了，萬一遇到壞人怎麼辦？", hat: "Black" },
          { id: "B", text: "這正是探險的好機會！說不定我會發現旅遊書上沒有的秘境。", hat: "Yellow" },
          { id: "C", text: "我需要找警察局或便利商店求助。", hat: "Blue" }
        ]
      }
    ]
  },
  Leadership: {
    label: "領導",
    icon: <Crown className="w-5 h-5" />,
    scenarios: [
      {
        level: "高階",
        score: 30,
        context: "團隊中有一位能力很強但態度消極的資深員工。",
        targetHat: "Red",
        options: [
          { id: "A", text: "根據績效考核，他的產出依然是部門前10%。", hat: "White" },
          { id: "B", text: "我感覺到他的負面情緒正在感染其他新人，這讓我對團隊氛圍很擔憂。", hat: "Red" },
          { id: "C", text: "我們可以請他擔任「特約顧問」，讓他獨立作業？", hat: "Green" }
        ]
      }
    ]
  }
};

const shuffleArray = (array) => {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
};

// -----------------------------------------------------------------------------
// 2. 子元件 (Sub-Components)
// -----------------------------------------------------------------------------

const NavBtn = ({ label, active, onClick, icon }) => (
  <button
    onClick={onClick}
    className={`flex items-center gap-1.5 px-3 py-2 rounded-lg transition-all whitespace-nowrap ${
      active ? 'bg-indigo-50 text-indigo-700 font-bold' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-700'
    }`}
  >
    {icon}
    <span className="hidden sm:inline">{label}</span>
  </button>
);

// New: Profile Modal for "Clicking User Name"
const ProfileModal = ({ user, onClose, openShare, openEmail }) => {
  if (!user) return null;
  const hat = user.hat;
  const info = hat ? HATS_INFO[hat] : null;

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] animate-fade-in p-4 overflow-y-auto">
      <div className="bg-white rounded-3xl max-w-2xl w-full shadow-2xl relative animate-scale-in my-8 max-h-[90vh] overflow-y-auto">
        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors z-20">
          <X className="w-5 h-5 text-slate-700" />
        </button>
        
        <div className="p-8">
          <div className="flex flex-col md:flex-row items-center gap-6 mb-8">
            <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-3xl font-bold text-indigo-600 shrink-0 border-4 border-indigo-50">
              {user.name[0].toUpperCase()}
            </div>
            <div className="text-center md:text-left flex-1">
              <h2 className="text-3xl font-bold text-slate-900 mb-1">{user.name}</h2>
              <p className="text-slate-500 flex items-center justify-center md:justify-start gap-1">
                <MapPin className="w-4 h-4" /> {user.location}
              </p>
            </div>
            <div className="text-center md:text-right bg-yellow-50 px-6 py-3 rounded-xl border border-yellow-100">
               <div className="text-xs text-yellow-600 uppercase font-bold tracking-wider mb-1">挑戰積分</div>
               <div className="text-4xl font-black text-yellow-500 flex items-center justify-center md:justify-end gap-1">
                 <Trophy className="w-6 h-6" /> {user.score}
               </div>
            </div>
          </div>

          <div className="border-t border-slate-100 pt-8">
            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
              <BookOpen className="w-5 h-5 text-indigo-500" /> 您的思維檔案
            </h3>
            
            {hat ? (
              <div className="bg-slate-50 rounded-2xl p-6 md:p-8 border border-slate-200 mb-8 relative overflow-hidden">
                <div className={`absolute top-0 right-0 w-32 h-32 opacity-5 pointer-events-none ${info.hatColor} rounded-bl-full transform translate-x-8 -translate-y-8`}></div>
                
                <div className="flex items-center gap-4 mb-6 relative z-10">
                  <div className={`p-4 rounded-2xl bg-white shadow-sm border border-slate-100`}>
                    <MagicHat className="w-12 h-12" color={info.strokeColor} />
                  </div>
                  <div>
                    <div className="text-sm text-slate-400 font-bold uppercase tracking-wider">分析結果</div>
                    <h3 className="text-2xl font-black text-slate-800">{info.name} 思考者</h3>
                  </div>
                </div>
                
                <p className="text-slate-600 leading-relaxed mb-6 text-lg whitespace-pre-line border-l-4 border-indigo-200 pl-4">
                  {info.detailedDesc}
                </p>
                
                <div className="p-6 bg-white rounded-xl border border-slate-100 shadow-sm">
                   <h4 className="font-bold text-indigo-600 mb-3 flex items-center gap-2 text-lg">
                     <Star className="w-5 h-5 fill-indigo-600" /> 深度剖析報告
                   </h4>
                   <p className="text-slate-700 leading-relaxed whitespace-pre-line">
                     {info.deepAnalysis}
                   </p>
                </div>
              </div>
            ) : (
              <div className="text-center py-12 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 mb-8">
                <div className="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                  <Lock className="w-8 h-8" />
                </div>
                <p className="text-slate-500 mb-6 font-medium">您尚未進行完整思維測驗，無法顯示分析報告。</p>
                <button onClick={() => { onClose(); }} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-md">
                  立即開始測驗
                </button>
              </div>
            )}
            
            {hat && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onClick={openShare} className="py-4 bg-indigo-100 text-indigo-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-200 transition-colors">
                  <Share2 className="w-5 h-5" /> 分享我的戰力卡
                </button>
                <button onClick={openEmail} className="py-4 bg-green-100 text-green-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-200 transition-colors">
                  <Mail className="w-5 h-5" /> 寄送報告到信箱
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const ShareModal = ({ user, onClose }) => {
  const hat = user.hat;
  const info = HATS_INFO[hat];

  const handleNativeShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: '六頂思考帽：思維實驗室',
          text: `我在思維實驗室測出了我是【${info.name}思考者】！\n我的關鍵字是：${info.keywords.slice(0, 3).join('、')}。\n快來測測你的大腦是什麼顏色？\nGame Design by Design Thinking POW WOW`,
          url: window.location.href,
        });
      } catch (err) {
        console.log('Error sharing:', err);
      }
    } else {
      alert("您的瀏覽器不支援直接分享，請截圖或複製連結！");
    }
  };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] animate-fade-in p-4 overflow-y-auto">
      <div className="bg-white rounded-3xl max-w-sm w-full shadow-2xl relative animate-scale-in my-8">
        <button onClick={onClose} className="absolute top-4 right-4 p-2 bg-black/10 rounded-full hover:bg-black/20 transition-colors z-20">
          <X className="w-5 h-5 text-slate-700" />
        </button>
        
        <div className={`aspect-[4/5] ${info.hatColor} p-8 flex flex-col items-center justify-center text-center relative overflow-hidden`}>
           <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white via-transparent to-transparent scale-150"></div>
           <MagicHat className="absolute -bottom-10 -right-10 w-48 h-48 opacity-10 rotate-12" color={info.color === 'Black' ? '#fff' : '#000'} />

           <div className="relative z-10 flex flex-col items-center flex-1 justify-center">
             <div className="bg-white/20 p-4 rounded-3xl backdrop-blur-md mb-6 shadow-lg">
               <MagicHat className="w-24 h-24" color={info.strokeColor} />
             </div>
             <h3 className="text-xl font-bold mb-1 opacity-80 uppercase tracking-widest">思維實驗室報告</h3>
             <h2 className="text-4xl font-black mb-4">{user.name}</h2>
             <div className="inline-block px-6 py-2 bg-white/20 rounded-full backdrop-blur-md text-xl font-bold mb-8 shadow-sm">
               我是 {info.name} 思考者
             </div>
             
             <div className="flex flex-wrap justify-center gap-2 mb-8">
               {info.keywords.slice(0, 3).map(k => (
                 <span key={k} className="px-3 py-1 bg-black/20 rounded-lg text-sm font-bold">#{k}</span>
               ))}
             </div>

              {user.score > 0 && (
                <div className="bg-black/20 px-6 py-3 rounded-2xl backdrop-blur-md flex items-center gap-3">
                  <Trophy className="w-6 h-6 text-yellow-300" />
                  <span className="font-black text-2xl text-yellow-300">{user.score}</span>
                  <span className="text-xs font-bold opacity-70 uppercase">Total Score</span>
                </div>
              )}
           </div>
           <div className="absolute bottom-4 text-xs font-bold opacity-50 tracking-widest">Game Design by Design Thinking POW WOW</div>
        </div>

        <div className="p-4 bg-slate-50">
          <button 
            onClick={handleNativeShare}
            className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 transition-colors shadow-lg"
          >
            <Share2 className="w-5 h-5" /> 分享到社群 / 複製連結
          </button>
          <p className="text-center text-slate-400 text-xs mt-3">
            或直接截圖上方卡片分享至 Instagram 限時動態
          </p>
        </div>
      </div>
    </div>
  );
};

const Registration = ({ onRegister }) => {
  const [name, setName] = useState('');
  const [location, setLocation] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (name.trim()) {
      onRegister(name.trim(), location.trim() || '未知的星球');
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-[80vh] animate-fade-in">
      <div className="bg-white p-8 md:p-12 rounded-3xl shadow-2xl max-w-md w-full border border-slate-100 text-center relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
        <div className="bg-indigo-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
          <MagicHat className="w-16 h-16" color="#4f46e5" />
        </div>
        <h1 className="text-3xl font-black text-slate-900 mb-2">六頂思考帽<br/><span className="text-indigo-600 text-2xl">思維實驗室</span></h1>
        
        <form onSubmit={handleSubmit} className="space-y-4 text-left">
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-1">您的暱稱</label>
            <input 
              type="text" 
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full p-4 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all font-bold text-lg"
              placeholder="例如：思考者小明"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-1">來自哪裡 (選填)</label>
            <input 
              type="text"
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              className="w-full p-4 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-white font-bold"
              placeholder="例如：台北"
            />
          </div>
          <button type="submit" className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-black transition-all transform hover:-translate-y-1 mt-4">
            進入實驗室
          </button>
        </form>
      </div>
    </div>
  );
};

const Introduction = ({ goQuiz }) => {
  return (
    <div className="max-w-4xl mx-auto animate-fade-in">
      <div className="text-center mb-16">
        <h1 className="text-4xl md:text-5xl font-black text-slate-900 mb-6">關於六頂思考帽</h1>
        <p className="text-xl text-slate-600 max-w-2xl mx-auto leading-relaxed">
          這不只是一個心理測驗，而是一套被全球企業、政府與教育機構採用的<br/>
          <span className="font-bold text-indigo-600">強力思維工具</span>。
        </p>
      </div>

      <div className="grid md:grid-cols-2 gap-12 items-start mb-16">
        <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
           <div className="flex items-center gap-4 mb-6">
             <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-3xl">👨‍🏫</div>
             <div>
               <h3 className="text-xl font-bold text-slate-800">愛德華·狄波諾</h3>
               <span className="text-sm text-slate-500">Edward de Bono (1933-2021)</span>
             </div>
           </div>
           <p className="text-slate-600 leading-relaxed mb-4">
             被譽為「水平思考」(Lateral Thinking) 之父。他是一位馬爾他醫師、心理學家、作家與發明家。他致力於教導人們「如何思考」，並認為思考是一項可以像運動一樣透過訓練變強的技能。
           </p>
           <p className="text-slate-600 leading-relaxed">
             他在 1985 年出版了《六頂思考帽》一書，迅速成為全球暢銷書，徹底改變了人們開會與決策的方式。
           </p>
        </div>

        <div className="bg-indigo-600 text-white p-8 rounded-[2.5rem] shadow-xl shadow-indigo-200">
           <div className="flex items-center gap-4 mb-6">
             <div className="w-16 h-16 bg-indigo-500 rounded-full flex items-center justify-center text-white">
               <Lightbulb className="w-8 h-8" />
             </div>
             <div>
               <h3 className="text-xl font-bold">核心概念</h3>
               <span className="text-indigo-200 text-sm">平行思考 vs 辯論思考</span>
             </div>
           </div>
           <p className="opacity-90 leading-relaxed mb-4">
             西方傳統思維強調「辯論」(Argument)，即 A 觀點攻擊 B 觀點，看誰贏。這往往導致自我防衛與時間浪費。
           </p>
           <p className="opacity-90 leading-relaxed">
             六頂帽提倡<span className="font-bold text-yellow-300">「平行思考」</span>(Parallel Thinking)。就像指揮家指揮樂隊：
           </p>
           <ul className="list-disc list-inside mt-2 space-y-1 opacity-90">
             <li>現在大家一起看優點（全體戴黃帽）</li>
             <li>現在大家一起看風險（全體戴黑帽）</li>
             <li>現在大家一起想創意（全體戴綠帽）</li>
           </ul>
        </div>
      </div>

      <div className="mb-16">
        <h3 className="text-2xl font-bold text-slate-800 mb-8 text-center">為什麼我們需要六頂帽？</h3>
        <div className="grid md:grid-cols-3 gap-6">
          <div className="p-6 bg-white border-2 border-slate-100 rounded-2xl hover:border-red-200 hover:shadow-lg transition-all">
            <h4 className="font-bold text-lg mb-2 text-red-600">移除自我 (Ego)</h4>
            <p className="text-slate-600 text-sm">
              當你戴上帽子時，你只是在扮演一個角色。你可以盡情批評（黑帽）或天馬行空（綠帽），而不用擔心被貼標籤。
            </p>
          </div>
          <div className="p-6 bg-white border-2 border-slate-100 rounded-2xl hover:border-blue-200 hover:shadow-lg transition-all">
            <h4 className="font-bold text-lg mb-2 text-blue-600">節省時間</h4>
            <p className="text-slate-600 text-sm">
              避免了無休止的爭論。大家朝同一個方向思考，能快速掃描問題的所有面向。
            </p>
          </div>
          <div className="p-6 bg-white border-2 border-slate-100 rounded-2xl hover:border-green-200 hover:shadow-lg transition-all">
            <h4 className="font-bold text-lg mb-2 text-green-600">釋放全腦潛能</h4>
            <p className="text-slate-600 text-sm">
              強迫邏輯型的人去感受（紅帽），強迫感性的人去分析數據（白帽），讓決策更全面。
            </p>
          </div>
        </div>
      </div>

      <div className="text-center">
        <button onClick={goQuiz} className="px-10 py-5 bg-slate-900 text-white rounded-full font-bold text-lg shadow-xl hover:bg-black transition-transform hover:-translate-y-1">
          了解了，開始我的思維測驗
        </button>
      </div>
    </div>
  );
};

const DailyHatCard = ({ user }) => {
  const [revealed, setRevealed] = useState(false);
  const [dailyHat, setDailyHat] = useState(null);
  const [dailyOracle, setDailyOracle] = useState("");

  useEffect(() => {
    const today = new Date().toDateString(); 
    let hash = 0;
    for (let i = 0; i < today.length; i++) {
      hash = today.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hats = Object.keys(HATS_INFO);
    const hatIndex = Math.abs(hash) % hats.length;
    const selectedHatKey = hats[hatIndex];
    setDailyHat(selectedHatKey);

    const hatInfo = HATS_INFO[selectedHatKey];
    const messageIndex = Math.abs(hash * 13) % hatInfo.oracles.length;
    setDailyOracle(hatInfo.oracles[messageIndex]);

  }, []);

  if (!dailyHat) return null;

  const info = HATS_INFO[dailyHat];

  return (
    <div className="max-w-xl mx-auto text-center py-10 animate-fade-in">
      <h2 className="text-3xl font-black text-slate-800 mb-2">每日帽卡</h2>
      <p className="text-slate-500 mb-10">抽取今日的思考守護神，指引你的行動方向</p>

      {!revealed ? (
        <button 
          onClick={() => setRevealed(true)}
          className="group relative w-64 h-96 mx-auto perspective-1000"
        >
          <div className="w-full h-full bg-gradient-to-br from-indigo-900 to-slate-900 rounded-3xl shadow-2xl flex flex-col items-center justify-center text-white border-4 border-indigo-400 transform transition-transform group-hover:scale-105 group-hover:rotate-1 cursor-pointer">
            <div className="bg-white/10 p-6 rounded-full mb-6 backdrop-blur-md">
               <MagicHat className="w-20 h-20" color="#fbbf24" />
            </div>
            <span className="text-2xl font-bold tracking-widest mb-2">點擊翻卡</span>
            <span className="text-xs opacity-50 font-mono">{new Date().toLocaleDateString()}</span>
            <div className="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity rounded-3xl"></div>
          </div>
        </button>
      ) : (
        <div className="animate-flip-in w-full max-w-md mx-auto">
          <div className={`bg-white rounded-[2rem] p-8 shadow-2xl border-4 ${info.color === 'White' ? 'border-slate-200' : `border-${info.color.toLowerCase()}-100`}`}>
            <div className="uppercase text-xs font-bold text-slate-400 tracking-widest mb-4">TODAY'S HAT</div>
            <div className={`w-32 h-32 mx-auto rounded-full flex items-center justify-center mb-6 ${info.style} bg-opacity-20`}>
              <MagicHat className="w-20 h-20" color={info.strokeColor} />
            </div>
            <h3 className={`text-4xl font-black mb-2 text-slate-800`}>
              {info.name}
            </h3>
            <p className="text-lg font-medium text-slate-500 mb-8">{info.meaning}</p>
            
            <div className="bg-slate-50 p-6 rounded-2xl relative border border-slate-100">
              <span className="absolute top-0 left-4 -mt-4 text-4xl text-slate-300">"</span>
              <p className="text-slate-700 text-lg leading-relaxed font-bold italic">
                {dailyOracle}
              </p>
              <span className="absolute bottom-0 right-4 -mb-8 text-4xl text-slate-300">"</span>
            </div>
            
            <p className="mt-8 text-xs text-slate-400 font-bold">
              每日限定一張，明天再來看看你的新帽子！
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

const Quiz = ({ user, onFinish }) => {
  const [setupMode, setSetupMode] = useState(true);
  const [questions, setQuestions] = useState([]);
  const [currentQ, setCurrentQ] = useState(0);
  const [quizLen, setQuizLen] = useState(0);
  const [scores, setScores] = useState({ White: 0, Red: 0, Black: 0, Yellow: 0, Green: 0, Blue: 0 });
  const [answeredInThisSession, setAnsweredInThisSession] = useState([]);

  const availableQuestions = useMemo(() => {
    const answered = new Set(user.answeredQuestions || []);
    return QUESTION_POOL.filter(q => !answered.has(q.id));
  }, [user.answeredQuestions]);

  const startQuiz = (length) => {
    if (availableQuestions.length === 0) {
      alert("太厲害了！你已經做完所有題目了！");
      return;
    }
    const actualLength = Math.min(length, availableQuestions.length);
    const shuffled = shuffleArray([...availableQuestions]);
    const selected = shuffled.slice(0, actualLength);

    setQuestions(selected);
    setQuizLen(length); 
    setSetupMode(false);
  };

  const handleAnswer = (hat) => {
    const newScores = { ...scores, [hat]: scores[hat] + 1 };
    setScores(newScores);
    
    const currentQId = questions[currentQ].id;
    const newAnswered = [...answeredInThisSession, currentQId];
    setAnsweredInThisSession(newAnswered);

    if (currentQ < questions.length - 1) {
      setCurrentQ(currentQ + 1);
    } else {
      const winner = Object.keys(newScores).reduce((a, b) => newScores[a] > newScores[b] ? a : b);
      const type = quizLen <= 5 ? 'quick' : 'deep';
      onFinish(winner, newAnswered, type); 
    }
  };

  if (setupMode) {
    const progressPercent = Math.round(((user.answeredQuestions?.length || 0) / QUESTION_POOL.length) * 100);

    return (
      <div className="max-w-4xl mx-auto animate-fade-in text-center py-10">
        <h2 className="text-3xl font-bold text-slate-800 mb-4">請選擇測驗模式</h2>
        <div className="mb-8">
           <div className="flex justify-between text-sm font-bold text-slate-500 mb-2 max-w-md mx-auto">
             <span>題庫完成度</span>
             <span>{progressPercent}%</span>
           </div>
           <div className="w-full max-w-md bg-slate-200 rounded-full h-3 mx-auto overflow-hidden">
             <div className="bg-indigo-600 h-full transition-all duration-1000" style={{ width: `${progressPercent}%` }}></div>
           </div>
           <p className="text-xs text-slate-400 mt-2">已完成 {(user.answeredQuestions?.length || 0)} / {QUESTION_POOL.length} 題</p>
        </div>

        {availableQuestions.length === 0 ? (
           <div className="p-10 bg-yellow-50 border-2 border-yellow-200 rounded-3xl">
             <Trophy className="w-20 h-20 text-yellow-500 mx-auto mb-4" />
             <h3 className="text-2xl font-black text-slate-800 mb-2">全制霸達成！</h3>
             <p className="text-slate-600">您已經完成了題庫中的所有挑戰。系統已為您在英雄榜上標記榮譽勳章。</p>
           </div>
        ) : (
          <div className="grid md:grid-cols-2 gap-6">
            <button onClick={() => startQuiz(3)} className="p-8 rounded-3xl bg-white border-2 border-slate-200 hover:border-orange-400 hover:shadow-xl transition-all group text-left relative overflow-hidden">
              <div className="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-orange-500 group-hover:text-white transition-colors text-orange-600">
                <Zap className="w-8 h-8" />
              </div>
              <h3 className="text-2xl font-black text-slate-800 mb-2">快速掃描</h3>
              <p className="text-slate-500 mb-4">隨機抽取 3 道<span className="text-orange-600 font-bold">新題目</span>。適合快速獲得當下狀態。</p>
            </button>

            <button onClick={() => startQuiz(10)} className="p-8 rounded-3xl bg-white border-2 border-slate-200 hover:border-indigo-500 hover:shadow-xl transition-all group text-left relative overflow-hidden">
              <div className="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-colors text-indigo-600">
                <MagicHat className="w-8 h-8" color="currentColor" />
              </div>
              <h3 className="text-2xl font-black text-slate-800 mb-2">深度人格剖析</h3>
              <p className="text-slate-500 mb-4">隨機抽取 10 道<span className="text-indigo-600 font-bold">新題目</span>。多維度情境，建立精準思維模型。</p>
            </button>
          </div>
        )}
      </div>
    );
  }

  const question = questions[currentQ];

  return (
    <div className="max-w-2xl mx-auto animate-fade-in">
      <div className="mb-8 flex items-center justify-between text-sm text-slate-500 font-medium">
        <span className="bg-slate-100 px-3 py-1 rounded-full text-slate-600">情境：{question.category}</span>
        <span>本次進度 {currentQ + 1} / {questions.length}</span>
      </div>
      
      <div className="w-full bg-slate-100 rounded-full h-2 mb-10 overflow-hidden">
        <div 
          className="bg-indigo-600 h-2 rounded-full transition-all duration-500 ease-out" 
          style={{ width: `${((currentQ + 1) / questions.length) * 100}%` }}
        />
      </div>

      <h2 className="text-2xl md:text-3xl font-bold text-slate-800 mb-8 leading-snug">
        {question.q}
      </h2>

      <div className="space-y-4">
        {question.options.map((opt, idx) => (
          <button
            key={idx}
            onClick={() => handleAnswer(opt.hat)}
            className="w-full text-left p-5 rounded-2xl border-2 border-slate-100 hover:border-indigo-600 hover:bg-indigo-50 transition-all group"
          >
            <div className="flex items-center gap-4">
              <span className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 font-bold group-hover:bg-indigo-200 group-hover:text-indigo-700 transition-colors shrink-0">
                {String.fromCharCode(65 + idx)}
              </span>
              <span className="text-slate-700 font-bold text-lg">{opt.text}</span>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
};

const Result = ({ user, quizType, goChallenge, goWiki, goLeaderboard, goDeepQuiz, openShare, openEmail }) => {
  const hat = user.hat;
  const info = HATS_INFO[hat];
  const percent = Math.round(((user.answeredQuestions?.length || 0) / QUESTION_POOL.length) * 100);
  const isDeep = quizType === 'deep';

  return (
    <div className="max-w-4xl mx-auto text-center animate-fade-in">
      <div className="inline-block px-4 py-1 rounded-full bg-indigo-100 text-indigo-700 text-sm font-bold mb-8">
        思維分析報告
      </div>
      
      <div className="bg-white rounded-[2rem] p-8 md:p-12 shadow-xl border border-slate-100 mb-10">
        <div className="flex flex-col md:flex-row gap-10 items-center text-left">
           <div className={`relative flex flex-col items-center justify-center p-10 rounded-3xl ${info.style} aspect-square w-full md:w-1/3 shrink-0`}>
            <div className="absolute inset-0 bg-white/20 rounded-3xl"></div>
            <div className={`relative w-32 h-32 rounded-full flex items-center justify-center bg-white shadow-xl mb-6`}>
              <MagicHat className={`w-24 h-24`} color={info.strokeColor} />
            </div>
            <h1 className="relative text-4xl font-black mb-2">{info.name}</h1>
            <p className="relative text-lg font-medium opacity-80">{info.meaning}</p>
          </div>

          <div className="flex-1">
            <div className="flex items-center justify-between mb-4 flex-wrap gap-4">
              <h2 className="text-3xl font-bold text-slate-800">{user.name}，你是 {info.name} 思考者</h2>
              <button onClick={openShare} className="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold flex items-center gap-2 hover:bg-indigo-200 transition-colors text-sm">
                <Share2 className="w-4 h-4" /> 分享卡片
              </button>
            </div>
            
            <p className="text-slate-600 leading-relaxed mb-6 text-lg whitespace-pre-line">
              {info.detailedDesc}
            </p>

            {isDeep ? (
              <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 mb-6 animate-fade-in">
                <h3 className="font-bold text-lg text-indigo-600 mb-4 flex items-center gap-2">
                  <Star className="w-5 h-5 fill-indigo-600" /> 深度人格剖析
                </h3>
                <p className="text-slate-700 leading-relaxed whitespace-pre-line mb-6">
                  {info.deepAnalysis}
                </p>
                <button onClick={openEmail} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-700 transition-colors shadow-md">
                  <Mail className="w-5 h-5" /> 📧 寄送完整分析報告給自己
                </button>
              </div>
            ) : (
              <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 mb-6 text-center">
                <div className="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                  <Lock className="w-6 h-6 text-slate-400" />
                </div>
                <h3 className="font-bold text-slate-800 mb-2">想要更深入的分析嗎？</h3>
                <p className="text-slate-500 text-sm mb-4">目前的快速掃描僅提供基礎結果。完成深度剖析（10題）即可解鎖詳細的人格說明與職涯建議，並將報告寄到您的信箱。</p>
                <button onClick={goDeepQuiz} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors">
                  解鎖完整報告 &rarr; 開始深度測驗
                </button>
              </div>
            )}
            
            <div className="flex flex-wrap gap-2 mt-6">
              {info.keywords.map(k => (
                <span key={k} className="px-3 py-1.5 bg-white text-slate-700 rounded-lg text-sm font-bold shadow-sm border border-slate-200">#{k}</span>
              ))}
            </div>
          </div>
        </div>
      </div>

      <div className="flex flex-col sm:flex-row gap-4 justify-center">
        <button onClick={goChallenge} className="px-8 py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition-colors shadow-lg flex items-center justify-center gap-2 text-lg">
          <Zap className="w-5 h-5" /> 挑戰換位思考
        </button>
        <button onClick={goLeaderboard} className="px-8 py-4 bg-yellow-400 text-yellow-900 rounded-xl font-bold hover:bg-yellow-500 transition-colors shadow-lg flex items-center justify-center gap-2 text-lg">
          <Trophy className="w-5 h-5" /> 查看英雄榜
        </button>
         <button onClick={goWiki} className="px-8 py-4 bg-white text-slate-600 border-2 border-slate-200 rounded-xl font-bold hover:bg-slate-50 transition-colors text-lg">
          詳細百科
        </button>
      </div>
    </div>
  );
};

const Leaderboard = ({ data, currentUser }) => {
  const sortedData = [...data]
    .filter(u => u.score > 0) // Only show users with score > 0 (Challenge mode points)
    .sort((a, b) => b.score - a.score);

  return (
    <div className="max-w-3xl mx-auto animate-fade-in">
      <div className="text-center mb-10">
        <h2 className="text-4xl font-black text-slate-900 mb-4 flex items-center justify-center gap-3">
          <Trophy className="w-10 h-10 text-yellow-500" />
          思維英雄榜
        </h2>
        <p className="text-slate-600">唯有透過【挑戰模式】累積積分的智者，才能留名於此</p>
      </div>

      <div className="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="grid grid-cols-12 bg-slate-50 p-4 font-bold text-slate-500 text-sm uppercase tracking-wider border-b border-slate-200">
          <div className="col-span-2 text-center">Rank</div>
          <div className="col-span-6">User</div>
          <div className="col-span-4 text-right pr-4">Score</div>
        </div>

        <div className="divide-y divide-slate-100">
          {sortedData.length > 0 ? (
            sortedData.map((u, index) => (
              <div key={index} className={`grid grid-cols-12 p-5 items-center ${u.name === currentUser.name ? 'bg-indigo-50' : 'hover:bg-slate-50'} transition-colors`}>
                <div className="col-span-2 text-center flex justify-center flex-col items-center">
                   {index === 0 && <span className="text-2xl">🥇</span>}
                   {index === 1 && <span className="text-2xl">🥈</span>}
                   {index === 2 && <span className="text-2xl">🥉</span>}
                   {index > 2 && <span className="font-bold text-slate-400 text-lg">#{index + 1}</span>}
                </div>
                
                <div className="col-span-6">
                  <div className="flex items-center gap-3">
                    <div className="font-bold text-lg text-slate-800 flex items-center gap-2">
                      {u.name}
                      {u.allCompleted && <Trophy className="w-4 h-4 text-yellow-500" title="思維大師：已完成所有題庫" />}
                    </div>
                    {u.hat && (
                      <div className={`p-1 rounded-full border ${HATS_INFO[u.hat].hatColor.replace('text-slate-700', 'border-slate-300')}`} title={`本命帽：${HATS_INFO[u.hat].name}`}>
                         <MagicHat className={`w-4 h-4`} color={HATS_INFO[u.hat].strokeColor} />
                      </div>
                    )}
                    {u.name === currentUser.name && (
                      <span className="px-2 py-0.5 bg-indigo-200 text-indigo-800 text-xs rounded font-bold">YOU</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2 text-xs text-slate-400 mt-1">
                    <MapPin className="w-3 h-3" /> {u.location}
                    <span>•</span>
                    <Clock className="w-3 h-3" /> {u.timestamp ? new Date(u.timestamp).toLocaleDateString() : 'Unknown'}
                  </div>
                </div>

                <div className="col-span-4 text-right pr-4">
                  <span className="text-2xl font-black text-indigo-600">{u.score}</span>
                  <span className="text-xs font-bold text-slate-400 ml-1">pts</span>
                </div>
              </div>
            ))
          ) : (
            <div className="p-10 text-center text-slate-400">
              目前還沒有人上榜，快去【挑戰模式】贏取積分吧！
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const Encyclopedia = () => {
  return (
    <div>
      <div className="text-center mb-12">
        <h2 className="text-4xl font-black text-slate-900 mb-4">六頂思考帽百科</h2>
        <p className="text-slate-600 max-w-2xl mx-auto">
          愛德華·狄波諾 (Edward de Bono) 提出的思考框架。<br/>
          了解每一頂帽子，能幫助你在決策時切換視角，避免盲點。
        </p>
      </div>
      
      <div className="space-y-12">
        {Object.values(HATS_INFO).map((hat) => (
          <div key={hat.name} className={`relative overflow-hidden rounded-[2.5rem] bg-white border-2 ${hat.color === 'White' ? 'border-slate-200' : `border-${hat.color.toLowerCase()}-100`} shadow-lg flex flex-col md:flex-row group`}>
            
            <div className={`md:w-1/4 p-8 flex flex-col items-center justify-center text-center relative overflow-hidden ${hat.hatColor}`}>
               <div className="relative z-10">
                 <div className="bg-white/20 p-4 rounded-3xl backdrop-blur-md mb-4 inline-flex">
                   <MagicHat className="w-16 h-16" color={hat.color === 'White' ? '#94a3b8' : 'currentColor'} />
                 </div>
                 <h3 className="text-4xl font-black mb-2">{hat.name}</h3>
                 <p className="font-medium opacity-90 text-lg">{hat.meaning}</p>
               </div>
            </div>
            
            {/* Content */}
            <div className="flex-1 p-8 md:p-10">
              <div className="mb-8">
                <h4 className="font-bold text-slate-400 uppercase tracking-wider text-sm mb-3">核心定義</h4>
                <p className="text-slate-700 text-lg leading-relaxed whitespace-pre-line">
                  {hat.detailedDesc}
                </p>
              </div>

              <div>
                <h4 className="font-bold text-slate-400 uppercase tracking-wider text-sm mb-4">代表人物</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {hat.celebrities.map((cel, idx) => (
                    <div key={idx} className="bg-slate-50 rounded-xl p-4 border border-slate-100 hover:border-indigo-200 transition-colors">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-lg">👑</span>
                        <span className="font-bold text-slate-800">{cel.name}</span>
                      </div>
                      <div className="text-xs font-bold text-indigo-500 mb-2">{cel.desc}</div>
                      <p className="text-sm text-slate-500 leading-snug">{cel.detail}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const Challenge = ({ user, onScoreUpdate, goLeaderboard }) => {
  const [step, setStep] = useState(1); // 1: Category, 2: Difficulty, 3: Scenario, 4: Feedback
  const [category, setCategory] = useState(null);
  const [difficulty, setDifficulty] = useState(null); // '初階', '中階', '高階'
  const [currentScenario, setCurrentScenario] = useState(null);
  const [selectedOption, setSelectedOption] = useState(null);
  const [isCorrect, setIsCorrect] = useState(false);
  const [scoreEarned, setScoreEarned] = useState(0);

  const categories = Object.keys(CHALLENGE_DB);
  const difficulties = ['初階', '中階', '高階'];

  // Step 1: Select Category
  const handleCategorySelect = (catKey) => {
    setCategory(CHALLENGE_DB[catKey]);
    setStep(2);
  };

  // Step 2: Select Difficulty & Start
  const handleDifficultySelect = (diff) => {
    setDifficulty(diff);
    
    // Filter scenarios by difficulty
    const scenarios = category.scenarios.filter(s => s.level === diff);
    const pool = scenarios.length > 0 ? scenarios : category.scenarios;
    
    // Random pick
    const finalScenario = pool[Math.floor(Math.random() * pool.length)];

    setCurrentScenario(finalScenario);
    setStep(3);
    setSelectedOption(null);
    setIsCorrect(false);
  };

  const checkAnswer = (option) => {
    setSelectedOption(option);
    const correct = option.hat === currentScenario.targetHat;
    setIsCorrect(correct);
    const points = correct ? currentScenario.score : 0;
    setScoreEarned(points);
    
    if (correct) {
      onScoreUpdate(points, {
        title: category.label,
        level: difficulty,
        hat: currentScenario.targetHat,
        result: 'Success',
        score: points,
        date: new Date().toISOString()
      });
    }

    setStep(4);
  };

  const reset = () => {
    setStep(1);
    setCategory(null);
    setDifficulty(null);
  };

  // Step 1: Category Selection
  if (step === 1) {
    return (
      <div className="max-w-5xl mx-auto animate-fade-in">
        <div className="bg-slate-900 rounded-[2.5rem] p-10 text-white mb-10 shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-600 rounded-full blur-3xl opacity-20 -mr-20 -mt-20"></div>
          
          <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
            <div>
              <div className="inline-block px-3 py-1 bg-indigo-500 rounded-full text-xs font-bold mb-4">訓練場</div>
              <h2 className="text-4xl font-bold mb-4">換位思考挑戰</h2>
              <p className="text-slate-300 max-w-lg text-lg">
                暫時放下你的{user.hat ? HATS_INFO[user.hat].name : "慣性思維"}，嘗試用指定的視角解決問題。<br/>
                累積積分，登上英雄榜。
              </p>
            </div>
            <div className="bg-white/10 p-6 rounded-3xl backdrop-blur-md text-center min-w-[160px] border border-white/10">
              <div className="text-xs uppercase tracking-wider opacity-60 mb-2">Total Score</div>
              <div className="text-6xl font-black text-yellow-400">{user.score}</div>
            </div>
          </div>
        </div>

        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
          <span className="w-8 h-8 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-sm">1</span>
          選擇挑戰情境
        </h3>
        
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
          {categories.map(catKey => {
            const cat = CHALLENGE_DB[catKey];
            return (
              <button
                key={catKey}
                onClick={() => handleCategorySelect(catKey)}
                className="flex flex-col items-center justify-center p-8 bg-white border-2 border-slate-100 rounded-3xl hover:shadow-xl hover:border-indigo-500 hover:-translate-y-1 transition-all group"
              >
                <div className="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 group-hover:bg-indigo-600 group-hover:text-white transition-colors mb-4">
                  {cat.icon}
                </div>
                <span className="font-bold text-lg text-slate-700 group-hover:text-indigo-700">{cat.label}</span>
              </button>
            );
          })}
        </div>
      </div>
    );
  }

  // Step 2: Difficulty Selection
  if (step === 2) {
    return (
      <div className="max-w-2xl mx-auto animate-slide-up text-center pt-10">
        <button onClick={() => setStep(1)} className="mb-8 text-slate-400 hover:text-slate-600 flex items-center justify-center gap-1 mx-auto font-bold">
           &larr; 返回情境選擇
        </button>
        <h2 className="text-3xl font-bold text-slate-800 mb-8">選擇挑戰難度</h2>
        <div className="grid gap-4">
          <button onClick={() => handleDifficultySelect('初階')} className="p-6 bg-white border-2 border-slate-200 rounded-2xl hover:border-green-500 hover:shadow-lg transition-all flex items-center justify-between group">
             <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-full bg-green-100 text-green-700 flex items-center justify-center font-bold text-xl">10</div>
                <div className="text-left">
                  <div className="text-xl font-bold text-slate-700 group-hover:text-green-700">初階</div>
                  <div className="text-sm text-slate-400">基礎單一思維切換</div>
                </div>
             </div>
             <ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-green-500" />
          </button>
          <button onClick={() => handleDifficultySelect('中階')} className="p-6 bg-white border-2 border-slate-200 rounded-2xl hover:border-yellow-500 hover:shadow-lg transition-all flex items-center justify-between group">
             <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-full bg-yellow-100 text-yellow-700 flex items-center justify-center font-bold text-xl">20</div>
                <div className="text-left">
                  <div className="text-xl font-bold text-slate-700 group-hover:text-yellow-700">中階</div>
                  <div className="text-sm text-slate-400">複雜情境應用</div>
                </div>
             </div>
             <ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-yellow-500" />
          </button>
          <button onClick={() => handleDifficultySelect('高階')} className="p-6 bg-white border-2 border-slate-200 rounded-2xl hover:border-red-500 hover:shadow-lg transition-all flex items-center justify-between group">
             <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-full bg-red-100 text-red-700 flex items-center justify-center font-bold text-xl">30</div>
                <div className="text-left">
                  <div className="text-xl font-bold text-slate-700 group-hover:text-red-700">高階</div>
                  <div className="text-sm text-slate-400">極端衝突與人性考驗</div>
                </div>
             </div>
             <ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-red-500" />
          </button>
        </div>
      </div>
    );
  }

  // Step 3 & 4: Challenge Active & Feedback
  const targetHatInfo = HATS_INFO[currentScenario.targetHat];

  return (
    <div className="max-w-3xl mx-auto animate-slide-up">
      <div className="mb-6 flex items-center justify-between">
        <button onClick={reset} className="text-slate-400 hover:text-slate-600 flex items-center gap-1 text-sm font-bold">
          <X className="w-4 h-4" /> 放棄挑戰
        </button>
        <span className="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-bold border border-slate-200 flex items-center gap-2">
          {category.label} &middot; {difficulty}
          <span className="bg-yellow-100 text-yellow-800 px-1.5 rounded-sm">+{currentScenario.score}分</span>
        </span>
      </div>

      <div className="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden mb-8">
        {/* Challenge Header */}
        <div className={`${targetHatInfo.hatColor} p-10 relative`}>
           <div className="flex items-center gap-6 relative z-10">
             <div className={`w-20 h-20 rounded-2xl flex items-center justify-center bg-white shadow-lg shrink-0`}>
                <MagicHat className={`w-12 h-12`} color={targetHatInfo.strokeColor} />
             </div>
             <div>
               <div className="text-xs font-bold uppercase tracking-wider opacity-60 mb-1">Current Mission</div>
               <h2 className="text-3xl font-black mb-1">戴上 {targetHatInfo.name}</h2>
               <p className="font-medium opacity-90">強制使用「{targetHatInfo.meaning}」的邏輯</p>
             </div>
           </div>
        </div>

        {/* Scenario */}
        <div className="p-8 md:p-10">
          <h3 className="text-xl font-bold text-slate-800 mb-8 leading-relaxed">
            <span className="block text-sm text-slate-400 mb-2 uppercase tracking-wide">情境</span>
            {currentScenario.context}
          </h3>

          <div className="space-y-4">
            {currentScenario.options.map((opt) => {
              const isSelected = selectedOption?.id === opt.id;
              const isThisCorrect = opt.hat === currentScenario.targetHat;
              
              let btnStyle = "border-slate-200 hover:border-indigo-400 hover:bg-slate-50"; // default
              if (step === 4) {
                if (isSelected && isThisCorrect) btnStyle = "border-green-500 bg-green-50 ring-2 ring-green-200";
                else if (isSelected && !isThisCorrect) btnStyle = "border-red-500 bg-red-50 opacity-60";
                else if (!isSelected && isThisCorrect) btnStyle = "border-green-500 bg-white border-dashed opacity-70";
                else btnStyle = "border-slate-100 opacity-30";
              }

              return (
                <button
                  key={opt.id}
                  disabled={step === 4}
                  onClick={() => checkAnswer(opt)}
                  className={`w-full text-left p-6 rounded-2xl border-2 transition-all duration-300 ${btnStyle}`}
                >
                  <div className="flex justify-between items-start">
                    <span className="text-slate-700 font-bold text-lg pr-4">{opt.text}</span>
                    {step === 4 && isThisCorrect && <CheckCircle className="w-6 h-6 text-green-500 shrink-0" />}
                    {step === 4 && isSelected && !isThisCorrect && <AlertCircle className="w-6 h-6 text-red-500 shrink-0" />}
                  </div>
                </button>
              );
            })}
          </div>

          {/* Feedback Section */}
          {step === 4 && (
            <div className={`mt-8 p-8 rounded-2xl animate-scale-in border-l-4 ${isCorrect ? 'bg-green-50 text-green-900 border-green-500' : 'bg-slate-50 text-slate-800 border-slate-400'}`}>
              <div className="flex items-center gap-3 mb-3">
                {isCorrect ? <Smile className="w-8 h-8 text-green-600" /> : <HelpCircle className="w-8 h-8 text-slate-500" />}
                <div>
                  <h4 className="font-bold text-xl">{isCorrect ? "挑戰成功！" : "再試一次！"}</h4>
                  {isCorrect && <span className="text-sm font-bold text-green-600">+{currentScenario.score} 分</span>}
                </div>
              </div>
              <p className="text-lg opacity-90 mb-8 leading-relaxed">
                {isCorrect 
                  ? `精準！這正是${targetHatInfo.name}的精髓。你成功運用了「${targetHatInfo.meaning}」來解決問題。`
                  : `這似乎更像是【${HATS_INFO[selectedOption.hat].name}】的思考方式。請記得，${targetHatInfo.name}的核心關注點是「${targetHatInfo.meaning}」。`
                }
              </p>
              
              <div className="flex gap-4">
                 <button 
                  onClick={reset}
                  className="flex-1 py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:bg-black transition-colors"
                >
                  下一題
                </button>
                <button 
                  onClick={goLeaderboard}
                  className="px-6 py-4 bg-yellow-400 text-yellow-900 rounded-xl font-bold hover:bg-yellow-500 transition-colors"
                >
                  查看排名
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// --- Home Component (Updated) ---
const Home = ({ user, goQuiz, goIntro, goDaily }) => (
  <div className="flex flex-col items-center justify-center py-12 text-center animate-fade-in">
    <div className="bg-indigo-100 p-6 rounded-3xl mb-8 rotate-3 hover:rotate-6 transition-transform duration-500">
      <MagicHat className="w-24 h-24" color="#4f46e5" />
    </div>
    <h1 className="text-4xl md:text-6xl font-black text-slate-900 mb-6 tracking-tight leading-tight">
      你好，{user.name}。<br/>
      你的思維，是什麼顏色？
    </h1>
    <p className="text-lg md:text-xl text-slate-600 max-w-2xl mb-10 leading-relaxed">
      透過「六頂思考帽」模型，探索你的潛意識決策模式。<br/>
      這不僅是測驗，更是一場關於思考的維度訓練。
    </p>

    {user.allCompleted && (
       <div className="mb-8 bg-yellow-100 border-2 border-yellow-400 text-yellow-800 px-6 py-3 rounded-xl font-bold flex items-center gap-2 animate-scale-in">
         <Trophy className="w-6 h-6" /> 恭喜！您已完成所有題庫訓練！
       </div>
    )}

    <div className="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
      <button onClick={goQuiz} className="px-8 py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-xl shadow-indigo-200 hover:bg-indigo-700 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2 text-lg">
        <Zap className="w-5 h-5" /> {user.hat ? '繼續訓練' : '開始測驗'}
      </button>
      <button onClick={goDaily} className="px-8 py-4 bg-white text-slate-700 border-2 border-slate-200 rounded-xl font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2 text-lg">
        <Calendar className="w-5 h-5" /> 每日帽卡
      </button>
       <button onClick={goIntro} className="px-8 py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:bg-black transition-all flex items-center justify-center gap-2 text-lg">
        <BookOpen className="w-5 h-5" /> 關於六頂帽
      </button>
    </div>

    {/* Color Strip */}
    <div className="mt-24 grid grid-cols-6 gap-0 w-full max-w-4xl h-3 rounded-full overflow-hidden opacity-80">
      <div className="bg-white border border-slate-200"></div>
      <div className="bg-red-600"></div>
      <div className="bg-black"></div>
      <div className="bg-yellow-400"></div>
      <div className="bg-green-600"></div>
      <div className="bg-blue-600"></div>
    </div>
  </div>
);

// -----------------------------------------------------------------------------
// 3. App 元件 (Main Component)
// -----------------------------------------------------------------------------

const App = () => {
  const [activeTab, setActiveTab] = useState('home'); 
  const [currentUser, setCurrentUser] = useState(null); 
  const [leaderboardData, setLeaderboardData] = useState([]);
  const [toast, setToast] = useState(null);
  const [showShareModal, setShowShareModal] = useState(false);
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [showProfileModal, setShowProfileModal] = useState(false); // New State
  const [quizType, setQuizType] = useState(null);

  useEffect(() => {
    const savedUsers = localStorage.getItem('sixHatsUsers');
    if (savedUsers) {
      setLeaderboardData(JSON.parse(savedUsers));
    }
  }, []);

  const handleRegister = (name, location) => {
    let user = leaderboardData.find(u => u.name.toLowerCase() === name.toLowerCase());
    
    if (user) {
      setCurrentUser(user);
      showToast(`歡迎回來，${user.name}`, "success");
    } else {
      const newUser = { 
        name, 
        location, 
        email: '', 
        hat: null, 
        score: 0, 
        history: [], 
        answeredQuestions: [], 
        timestamp: new Date().toISOString() 
      };
      setCurrentUser(newUser);
      showToast(`歡迎加入思維實驗室，${name}`, "success");
    }
    return true;
  };

  const handleUpdateUser = (updates) => {
    setCurrentUser(prev => {
      const updated = { ...prev, ...updates };
      if (updated.answeredQuestions && updated.answeredQuestions.length >= QUESTION_POOL.length && prev.answeredQuestions.length < QUESTION_POOL.length) {
         // Ensure score update logic is correct based on game mode
         // But for general updates, we just merge
         if (!updated.allCompleted) { // Only notify once
            updated.score = (updated.score || 0) + 500; 
            updated.allCompleted = true;
            showToast("🏆 恭喜！你已完成所有題庫，獲得思維大師稱號！", "success");
         }
      }

      const newLeaderboard = leaderboardData.filter(u => u.name !== prev.name).concat(updated);
      setLeaderboardData(newLeaderboard);
      localStorage.setItem('sixHatsUsers', JSON.stringify(newLeaderboard));
      
      return updated;
    });
  };

  const handleLogout = (e) => {
    e.stopPropagation(); 
    setCurrentUser(null);
    setActiveTab('home');
    setQuizType(null);
  };

  const handleEmailSubmit = (email) => {
    if (!email || !email.includes('@')) {
      showToast("請輸入有效的 Email", "error");
      return;
    }
    handleUpdateUser({ email });
    showToast("報告已發送至您的信箱！", "success");
    setShowEmailModal(false);
  };

  const showToast = (msg, type) => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  };

  const renderContent = () => {
    if (!currentUser) return <Registration onRegister={handleRegister} />;

    switch(activeTab) {
      case 'home': return <Home user={currentUser} goQuiz={() => setActiveTab('quiz')} goIntro={() => setActiveTab('intro')} goDaily={() => setActiveTab('daily')} />;
      case 'intro': return <Introduction goQuiz={() => setActiveTab('quiz')} />;
      case 'daily': return <DailyHatCard user={currentUser} />;
      case 'quiz': return <Quiz user={currentUser} onFinish={(hat, answeredIds, type) => { 
        setQuizType(type);
        // Quiz does NOT add score, only updates hat and answered history
        handleUpdateUser({ 
          hat,
          answeredQuestions: [...(currentUser.answeredQuestions || []), ...answeredIds]
        }); 
        setActiveTab('result'); 
      }} />;
      case 'result': return <Result user={currentUser} quizType={quizType} goChallenge={() => setActiveTab('challenge')} goWiki={() => setActiveTab('encyclopedia')} goLeaderboard={() => setActiveTab('leaderboard')} goDeepQuiz={() => { setActiveTab('quiz'); }} openShare={() => setShowShareModal(true)} openEmail={() => setShowEmailModal(true)} />;
      case 'encyclopedia': return <Encyclopedia />;
      case 'challenge': return <Challenge user={currentUser} onScoreUpdate={(points, record) => {
        // Challenge ADDS score
        handleUpdateUser({ 
          score: (currentUser.score || 0) + points, 
          history: [record, ...currentUser.history] 
        });
      }} goLeaderboard={() => setActiveTab('leaderboard')} />;
      case 'leaderboard': return <Leaderboard data={leaderboardData} currentUser={currentUser} />;
      default: return <Home user={currentUser} />;
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100 relative">
      {/* Navigation Bar */}
      <nav className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2 cursor-pointer group" onClick={() => currentUser && setActiveTab('home')}>
            <div className="bg-indigo-600 p-1.5 rounded-lg group-hover:rotate-12 transition-transform">
              <MagicHat className="w-6 h-6" color="#fff" />
            </div>
            <span className="font-bold text-lg md:text-xl tracking-tight text-slate-800 hidden md:block">
              六頂思考帽：<span className="text-indigo-600">思維實驗室</span>
            </span>
            <span className="font-bold text-lg md:text-xl tracking-tight text-slate-800 md:hidden">
              思維實驗室
            </span>
          </div>
          
          {currentUser && (
            <div className="flex items-center gap-2 md:gap-4">
              <div className="flex items-center gap-1 overflow-x-auto no-scrollbar md:pr-0">
                <NavBtn label="關於" active={activeTab === 'intro'} onClick={() => setActiveTab('intro')} icon={<Info className="w-4 h-4" />} />
                <NavBtn label="每日帽卡" active={activeTab === 'daily'} onClick={() => setActiveTab('daily')} icon={<Calendar className="w-4 h-4" />} />
                <NavBtn label="測驗" active={activeTab === 'quiz' || activeTab === 'result'} onClick={() => setActiveTab('quiz')} icon={<CheckCircle className="w-4 h-4" />} />
                <NavBtn label="百科" active={activeTab === 'encyclopedia'} onClick={() => setActiveTab('encyclopedia')} icon={<BookOpen className="w-4 h-4" />} />
                <NavBtn label="挑戰" active={activeTab === 'challenge'} onClick={() => setActiveTab('challenge')} icon={<Zap className="w-4 h-4" />} />
                <NavBtn label="英雄榜" active={activeTab === 'leaderboard'} onClick={() => setActiveTab('leaderboard')} icon={<Trophy className="w-4 h-4" />} />
              </div>
              
              <div className="hidden md:block h-6 w-px bg-slate-200"></div>
              
              {/* Clickable User Profile Trigger */}
              <div 
                className="hidden md:flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full cursor-pointer hover:bg-slate-200 transition-colors"
                onClick={() => setShowProfileModal(true)}
                title="點擊查看個人檔案"
              >
                <User className="w-4 h-4 text-slate-500" />
                <span className="text-sm font-bold text-slate-700 max-w-[100px] truncate">{currentUser.name}</span>
              </div>
              
              <button 
                onClick={handleLogout} 
                className="relative z-50 p-2 bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-600 rounded-full transition-colors cursor-pointer ml-1" 
                title="登出"
              >
                <LogOut className="w-5 h-5" />
              </button>
            </div>
          )}
        </div>
      </nav>

      <main className="max-w-6xl mx-auto px-4 py-8 pb-20 relative z-0">
        {renderContent()}
      </main>

      {activeTab === 'home' && (
        <footer className="max-w-4xl mx-auto mt-12 mb-8 p-6 text-center border-t border-slate-200 text-slate-400 text-sm">
           <p className="font-bold text-slate-500 mb-2">Game Design by Design Thinking POW WOW</p>
           <p className="opacity-75 mb-2">⚠️ 免責聲明：本程式僅為教育與娛樂用途的模擬遊戲。</p>
           <p className="opacity-75">「六頂思考帽」是愛德華·狄波諾博士的經典理論。希望大家在享受遊戲的同時，能夠購買原著《六頂思考帽》深入研究，獲得完整的知識體驗。</p>
        </footer>
      )}

      {showShareModal && currentUser && currentUser.hat && (
        <ShareModal user={currentUser} onClose={() => setShowShareModal(false)} />
      )}

      {/* Profile Modal */}
      {showProfileModal && (
        <ProfileModal 
          user={currentUser} 
          onClose={() => setShowProfileModal(false)} 
          openShare={() => { setShowProfileModal(false); setShowShareModal(true); }}
          openEmail={() => { setShowProfileModal(false); setShowEmailModal(true); }}
        />
      )}

      {showEmailModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] animate-fade-in p-4">
          <div className="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl relative animate-scale-in">
            <button onClick={() => setShowEmailModal(false)} className="absolute top-4 right-4 p-1 rounded-full hover:bg-slate-100 transition-colors">
              <X className="w-5 h-5 text-slate-400" />
            </button>
            
            <div className="text-center mb-6">
              <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Mail className="w-8 h-8 text-green-600" />
              </div>
              <h3 className="text-xl font-bold text-slate-800">索取詳細深度報告</h3>
              <p className="text-sm text-slate-500 mt-2">輸入您的 Email，我們將把詳細的帽子分析報告與進階建議寄給您。</p>
            </div>

            <form onSubmit={(e) => { e.preventDefault(); handleEmailSubmit(e.target.email.value); }}>
              <input 
                type="email" 
                name="email" 
                placeholder="name@example.com" 
                className="w-full p-3 border-2 border-slate-200 rounded-xl mb-4 focus:border-indigo-500 outline-none font-bold"
                defaultValue={currentUser.email || ''}
                required 
              />
              <button type="submit" className="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                <Send className="w-4 h-4" /> 確認發送
              </button>
            </form>
          </div>
        </div>
      )}

      {toast && (
        <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg font-bold text-white z-[100] animate-slide-up ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
          {toast.msg}
        </div>
      )}
    </div>
  );
};

export default App;